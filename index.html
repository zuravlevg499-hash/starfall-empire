<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Starfall Empire üöÄ</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ —Å—Ç–∏–ª–∏ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #0a0a2a, #1a1a4a);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        h1 {
            color: #00d4ff;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .player-name {
            color: #a0a0ff;
            font-size: 16px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            margin: 5px 0;
        }
        
        .resources .stat-value { color: #00ffaa; }
        .level .stat-value { color: #ffaa00; }
        .crystals .stat-value { color: #ff00aa; }
        .energy .stat-value { color: #00aaff; }
        
        .stat-label {
            color: #a0a0ff;
            font-size: 14px;
        }
        
        .boosts {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid gold;
            border-radius: 10px;
            padding: 10px;
            margin: 10px 0;
            font-size: 14px;
            display: none;
        }
        
        .actions {
            display: grid;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .btn {
            background: linear-gradient(45deg, #0088ff, #00d4ff);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 12px;
            font-size: 16px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 212, 255, 0.3);
        }
        
        .btn-shop {
            background: linear-gradient(45deg, #ff0088, #ff00d4);
        }
        
        .btn-upgrades {
            background: linear-gradient(45deg, #00cc66, #00ffaa);
        }
        
        .btn-referral {
            background: linear-gradient(45deg, #9b59b6, #8e44ad);
        }
        
        .btn-daily {
            background: linear-gradient(45deg, #ff8800, #ffaa00);
        }
        
        .btn-pvp {
            background: linear-gradient(45deg, #ff4444, #ff6666);
        }
        
        .status {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            margin-top: 20px;
            border-left: 4px solid #0088ff;
            text-align: center;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }
        
        .modal-content {
            background: #1a1a4a;
            border-radius: 20px;
            padding: 20px;
            max-width: 400px;
            margin: 0 auto;
            border: 2px solid #00d4ff;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .close-btn {
            background: #ff4444;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
        }
        
        .shop-item, .upgrade-item, .pvp-opponent, .daily-reward {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .shop-item-header, .upgrade-item-header, .pvp-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .btn-buy {
            width: 100%;
            padding: 10px;
            background: linear-gradient(45deg, #00cc66, #00ffaa);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .btn-buy:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .stars-package {
            border: 2px solid gold;
            background: rgba(255, 215, 0, 0.1);
        }
        
        .stars-price {
            color: gold;
            font-size: 20px;
        }
        
        .btn-stars {
            background: linear-gradient(45deg, gold, #ffd700);
            color: #000;
        }
        
        .payment-modal {
            background: rgba(0, 0, 0, 0.9);
        }
        
        .payment-success {
            background: rgba(0, 255, 170, 0.1);
            border: 2px solid #00ffaa;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin: 20px 0;
        }
        
        .payment-error {
            background: rgba(255, 68, 68, 0.1);
            border: 2px solid #ff4444;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin: 20px 0;
        }
        
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid #00d4ff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .daily-streak {
            display: flex;
            justify-content: space-between;
            margin: 15px 0;
        }
        
        .day-box {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            background: rgba(255,255,255,0.1);
            border: 2px solid #666;
        }
        
        .day-box.active {
            background: linear-gradient(45deg, #ff8800, #ffaa00);
            border-color: #ffaa00;
        }
        
        .day-box.claimed {
            background: linear-gradient(45deg, #00cc66, #00ffaa);
            border-color: #00ffaa;
        }
        
        .battle-log {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .battle-log-item {
            margin: 5px 0;
            padding-left: 10px;
            border-left: 3px solid #ff4444;
        }
        
        .win {
            color: #00ffaa;
            border-left-color: #00ffaa;
        }
        
        .lose {
            color: #ff4444;
            border-left-color: #ff4444;
        }
        
        .pvp-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }
        
        .stat-box {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 10px;
            text-align: center;
        }
        
        .stat-box-value {
            font-size: 20px;
            font-weight: bold;
            color: #00d4ff;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üöÄ STARFALL EMPIRE</h1>
            <div class="player-name" id="playerName">–ö–æ—Å–º–∏—á–µ—Å–∫–∞—è —Å—Ç–∞–Ω—Ü–∏—è</div>
        </header>
        
        <div class="stats-grid">
            <div class="stat-card resources">
                <div class="stat-label">‚ö° –†–ï–°–£–†–°–´</div>
                <div class="stat-value" id="resources">0</div>
            </div>
            
            <div class="stat-card level">
                <div class="stat-label">üèóÔ∏è –£–†–û–í–ï–ù–¨</div>
                <div class="stat-value" id="level">0</div>
            </div>
            
            <div class="stat-card crystals">
                <div class="stat-label">üíé –ö–†–ò–°–¢–ê–õ–õ–´</div>
                <div class="stat-value" id="crystals">0</div>
            </div>
            
            <div class="stat-card energy">
                <div class="stat-label">üîã –≠–ù–ï–†–ì–ò–Ø</div>
                <div class="stat-value" id="energy">100%</div>
            </div>
        </div>
        
        <div class="boosts" id="boosts"></div>
        
        <div class="actions">
            <button class="btn" onclick="collectResources()">
                üõ†Ô∏è –°–û–ë–†–ê–¢–¨ –†–ï–°–£–†–°–´
            </button>
            
            <button class="btn" onclick="upgradeStation()">
                ‚ö° –£–õ–£–ß–®–ò–¢–¨ –°–¢–ê–ù–¶–ò–Æ
            </button>
            
            <button class="btn btn-daily" onclick="openDailyRewards()">
                üéÅ –ï–ñ–ï–î–ù–ï–í–ù–ê–Ø –ù–ê–ì–†–ê–î–ê
            </button>
            
            <button class="btn btn-pvp" onclick="openPvP()">
                ‚öîÔ∏è PvP –ë–ò–¢–í–ê
            </button>
            
            <button class="btn btn-upgrades" onclick="openUpgrades()">
                ‚öôÔ∏è –£–õ–£–ß–®–ï–ù–ò–Ø
            </button>
            
            <button class="btn btn-shop" onclick="openShop()">
                üõí –ú–ê–ì–ê–ó–ò–ù
            </button>
            
            <button class="btn btn-referral" onclick="openReferrals()">
                üë• –ü–†–ò–ì–õ–ê–°–ò–¢–¨ –î–†–£–ó–ï–ô
            </button>
        </div>
        
        <div class="status" id="status">
            ‚ö° –ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª–∫–∞ —É–ª—É—á—à–µ–Ω–∏–π -->
    <div class="modal" id="upgradesModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚öôÔ∏è –£–õ–£–ß–®–ï–ù–ò–Ø –°–¢–ê–ù–¶–ò–ò</h3>
                <button class="close-btn" onclick="closeModal('upgradesModal')">√ó</button>
            </div>
            <div id="upgradesList"></div>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª–∫–∞ –º–∞–≥–∞–∑–∏–Ω–∞ -->
    <div class="modal" id="shopModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üõí –ú–ê–ì–ê–ó–ò–ù</h3>
                <button class="close-btn" onclick="closeModal('shopModal')">√ó</button>
            </div>
            <div id="shopList"></div>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ -->
    <div class="modal" id="referralsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üë• –ü–†–ò–ì–õ–ê–°–ò–¢–¨ –î–†–£–ó–ï–ô</h3>
                <button class="close-btn" onclick="closeModal('referralsModal')">√ó</button>
            </div>
            <div id="referralsContent"></div>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª–∫–∞ –µ–∂–µ–¥–Ω–µ–≤–Ω—ã—Ö –Ω–∞–≥—Ä–∞–¥ -->
    <div class="modal" id="dailyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üéÅ –ï–ñ–ï–î–ù–ï–í–ù–´–ï –ù–ê–ì–†–ê–î–´</h3>
                <button class="close-btn" onclick="closeModal('dailyModal')">√ó</button>
            </div>
            <div id="dailyContent"></div>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª–∫–∞ PvP -->
    <div class="modal" id="pvpModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚öîÔ∏è PvP –ë–ò–¢–í–´</h3>
                <button class="close-btn" onclick="closeModal('pvpModal')">√ó</button>
            </div>
            <div id="pvpContent"></div>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π -->
    <div class="modal payment-modal" id="paymentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚≠ê –û–ü–õ–ê–¢–ê TELEGRAM STARS</h3>
                <button class="close-btn" onclick="closeModal('paymentModal')">√ó</button>
            </div>
            <div id="paymentContent"></div>
        </div>
    </div>
    
    <script>
        // Telegram Web App
        const tg = window.Telegram.WebApp;
        let playerData = null;
        let playerId = null;
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        tg.expand();
        tg.MainButton.setText('–ó–ê–ö–†–´–¢–¨').show();
        tg.MainButton.onClick(() => tg.close());
        
        // –ü–æ–ª—É—á–∞–µ–º ID –∏–≥—Ä–æ–∫–∞
        function getPlayerId() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('startapp');
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–≥—Ä–æ–∫–∞
        async function loadPlayerData() {
            playerId = getPlayerId();
            
            if (!playerId) {
                showStatus('–ù–∞–ø–∏—à–∏—Ç–µ /start –±–æ—Ç—É', 'warning');
                return;
            }
            
            try {
                const response = await fetch(`/api/player/${playerId}`);
                if (response.ok) {
                    playerData = await response.json();
                    updateDisplay();
                    showStatus('‚úÖ –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã', 'success');
                } else {
                    showStatus('‚ùå –ò–≥—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω. –ù–∞–ø–∏—à–∏—Ç–µ /start', 'error');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
                showStatus('‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'warning');
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        function updateDisplay() {
            if (!playerData) return;
            
            document.getElementById('resources').textContent = playerData.resources;
            document.getElementById('level').textContent = playerData.level;
            document.getElementById('crystals').textContent = playerData.crystals;
            
            const now = Date.now();
            const lastCollect = playerData.last_collect || playerData.lastCollect || now;
            const hoursPassed = (now - lastCollect) / (1000 * 60 * 60);
            const energy = Math.min(100, Math.floor(hoursPassed * 20));
            document.getElementById('energy').textContent = energy + '%';
            
            const boostsEl = document.getElementById('boosts');
            let boostsHTML = '';
            
            const boostUntil = playerData.boost_until || playerData.boostUntil || 0;
            const shieldUntil = playerData.shield_until || playerData.shieldUntil || 0;
            
            if (boostUntil > now) {
                const minsLeft = Math.floor((boostUntil - now) / (1000 * 60));
                boostsHTML += `‚ö° –ë—É—Å—Ç–µ—Ä x2: ${minsLeft} –º–∏–Ω.<br>`;
            }
            
            if (shieldUntil > now) {
                const hoursLeft = Math.floor((shieldUntil - now) / (1000 * 60 * 60));
                boostsHTML += `üõ°Ô∏è –©–∏—Ç –∑–∞—â–∏—Ç—ã: ${hoursLeft} —á.`;
            }
            
            if (boostsHTML) {
                boostsEl.innerHTML = boostsHTML;
                boostsEl.style.display = 'block';
            } else {
                boostsEl.style.display = 'none';
            }
        }
        
        // –°–±–æ—Ä —Ä–µ—Å—É—Ä—Å–æ–≤
        async function collectResources() {
            if (!playerData || !playerId) {
                showStatus('–°–Ω–∞—á–∞–ª–∞ –Ω–∞–ø–∏—à–∏—Ç–µ /start –±–æ—Ç—É', 'error');
                return;
            }
            
            const now = Date.now();
            const lastCollect = playerData.last_collect || playerData.lastCollect || now;
            const hoursPassed = (now - lastCollect) / (1000 * 60 * 60);
            
            if (hoursPassed >= 1) {
                let collected = 10 * playerData.level;
                const boostUntil = playerData.boost_until || playerData.boostUntil || 0;
                
                if (boostUntil > now) collected *= 2;
                
                playerData.resources += collected;
                playerData.lastCollect = now;
                playerData.last_collect = now;
                
                try {
                    const response = await fetch(`/api/player/${playerId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(playerData)
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        playerData = result.player;
                        updateDisplay();
                        showStatus(`‚úÖ –°–æ–±—Ä–∞–Ω–æ ${collected} —Ä–µ—Å—É—Ä—Å–æ–≤!`, 'success');
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
                }
            } else {
                const lastCollect = playerData.last_collect || playerData.lastCollect || now;
                const minutesLeft = 60 - Math.floor((now - lastCollect) / (1000 * 60));
                showStatus(`‚è≥ –†–µ—Å—É—Ä—Å—ã —á–µ—Ä–µ–∑ ${minutesLeft} –º–∏–Ω.`, 'warning');
            }
        }
        
        // –£–ª—É—á—à–µ–Ω–∏–µ —Å—Ç–∞–Ω—Ü–∏–∏
        async function upgradeStation() {
            if (!playerData || !playerId) return;
            
            const cost = 50 * playerData.level;
            
            if (playerData.resources >= cost) {
                playerData.resources -= cost;
                playerData.level++;
                
                try {
                    const response = await fetch(`/api/player/${playerId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(playerData)
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        playerData = result.player;
                        updateDisplay();
                        showStatus(`üéâ –£—Ä–æ–≤–µ–Ω—å ${playerData.level}!`, 'success');
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
                }
            } else {
                showStatus(`‚ùå –ù—É–∂–Ω–æ ${cost} —Ä–µ—Å—É—Ä—Å–æ–≤`, 'error');
            }
        }
        
        // –ü–æ–∫—É–ø–∫–∞ —á–µ—Ä–µ–∑ Telegram Stars
        async function buyWithTelegramStars(stars) {
            if (!playerData || !playerId) {
                showStatus('–°–Ω–∞—á–∞–ª–∞ –Ω–∞–ø–∏—à–∏—Ç–µ /start –±–æ—Ç—É', 'error');
                return;
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
            const paymentContent = document.getElementById('paymentContent');
            paymentContent.innerHTML = `
                <div style="text-align:center;padding:40px;">
                    <div class="loader"></div>
                    <p>–°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞...</p>
                </div>
            `;
            document.getElementById('paymentModal').style.display = 'block';
            
            try {
                // –ü–æ–ª—É—á–∞–µ–º –∏–Ω–≤–æ–π—Å
                const response = await fetch('/api/create-invoice', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        playerId: playerId,
                        stars: stars,
                        description: '–ü–æ–∫—É–ø–∫–∞ –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤ –≤ Starfall Empire'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –Ω—É–∂–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å –∏–Ω–≤–æ–π—Å —á–µ—Ä–µ–∑ Telegram Payments
                    // –î–ª—è —Ç–µ—Å—Ç–∞ –∏–º–∏—Ç–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω—ã–π –ø–ª–∞—Ç–µ–∂
                    
                    paymentContent.innerHTML = `
                        <div style="text-align:center;">
                            <h3>–¢–µ—Å—Ç–æ–≤—ã–π –ø–ª–∞—Ç–µ–∂</h3>
                            <p>–í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –æ–∫–Ω–æ –æ–ø–ª–∞—Ç—ã Telegram Stars</p>
                            <div style="background:rgba(255,255,255,0.1);padding:20px;border-radius:10px;margin:20px 0;">
                                <p>–ü–∞–∫–µ—Ç: ${result.package.label}</p>
                                <p>–¶–µ–Ω–∞: ${stars} ‚≠ê</p>
                                <p>–í—ã –ø–æ–ª—É—á–∏—Ç–µ: ${result.package.crystals} üíé</p>
                            </div>
                            <button class="btn-buy" onclick="confirmTestPayment(${stars}, '${result.invoice.payload}')" style="background:linear-gradient(45deg,gold,#ffd700);color:#000;">
                                üîí –ü–†–û–¢–ï–°–¢–ò–†–û–í–ê–¢–¨ –û–ü–õ–ê–¢–£
                            </button>
                            <button class="btn-buy" onclick="closeModal('paymentModal')" style="background:#666;margin-top:10px;">
                                –û—Ç–º–µ–Ω–∞
                            </button>
                        </div>
                    `;
                } else {
                    paymentContent.innerHTML = `
                        <div class="payment-error">
                            <h3>–û—à–∏–±–∫–∞</h3>
                            <p>${result.error}</p>
                            <button class="btn-buy" onclick="closeModal('paymentModal')">
                                –ó–∞–∫—Ä—ã—Ç—å
                            </button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞:', error);
                paymentContent.innerHTML = `
                    <div class="payment-error">
                        <h3>–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</h3>
                        <p>–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø–ª–∞—Ç–µ–∂. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.</p>
                        <button class="btn-buy" onclick="closeModal('paymentModal')">
                            –ó–∞–∫—Ä—ã—Ç—å
                        </button>
                    </div>
                `;
            }
        }
        
        // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞
        async function confirmTestPayment(stars, payload) {
            const paymentContent = document.getElementById('paymentContent');
            paymentContent.innerHTML = `
                <div style="text-align:center;padding:40px;">
                    <div class="loader"></div>
                    <p>–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–∞...</p>
                </div>
            `;
            
            try {
                const response = await fetch('/api/confirm-payment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        playerId: playerId,
                        payload: payload,
                        stars: stars
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    paymentContent.innerHTML = `
                        <div class="payment-success">
                            <h3>‚úÖ –£—Å–ø–µ—à–Ω–æ!</h3>
                            <p>${result.message}</p>
                            <p>–í–∞—à–∏ –∫—Ä–∏—Å—Ç–∞–ª–ª—ã –¥–æ–±–∞–≤–ª–µ–Ω—ã –Ω–∞ —Å—á–µ—Ç.</p>
                            <button class="btn-buy" onclick="closeModalAndReload()" style="background:linear-gradient(45deg,#00cc66,#00ffaa);">
                                –û—Ç–ª–∏—á–Ω–æ!
                            </button>
                        </div>
                    `;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∏–≥—Ä–æ–∫–∞
                    playerData = result.player;
                    updateDisplay();
                } else {
                    paymentContent.innerHTML = `
                        <div class="payment-error">
                            <h3>–û—à–∏–±–∫–∞</h3>
                            <p>${result.error}</p>
                            <button class="btn-buy" onclick="closeModal('paymentModal')">
                                –ó–∞–∫—Ä—ã—Ç—å
                            </button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞:', error);
                paymentContent.innerHTML = `
                    <div class="payment-error">
                        <h3>–û—à–∏–±–∫–∞</h3>
                        <p>–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –ø–ª–∞—Ç–µ–∂.</p>
                        <button class="btn-buy" onclick="closeModal('paymentModal')">
                            –ó–∞–∫—Ä—ã—Ç—å
                        </button>
                    </div>
                `;
            }
        }
        
        function closeModalAndReload() {
            closeModal('paymentModal');
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –º–∞–≥–∞–∑–∏–Ω
            openStarsShop();
        }
        
        // –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (–µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –Ω–∞–≥—Ä–∞–¥—ã, PvP, —É–ª—É—á—à–µ–Ω–∏—è, –º–∞–≥–∞–∑–∏–Ω, —Ä–µ—Ñ–µ—Ä–∞–ª—ã)
        // ... (—Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏, –∞–¥–∞–ø—Ç–∏—Ä—É–µ–º –¥–ª—è –Ω–æ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö)
        
        // –û—Ç–∫—Ä—ã—Ç—å –º–∞–≥–∞–∑–∏–Ω Stars
        async function openStarsShop() {
            try {
                const response = await fetch('/api/starpackages');
                const starPackages = await response.json();
                
                const container = document.getElementById('shopList');
                container.innerHTML = '<h3>‚≠ê TELEGRAM STARS</h3>';
                
                starPackages.forEach(pack => {
                    const div = document.createElement('div');
                    div.className = 'shop-item stars-package';
                    
                    div.innerHTML = `
                        <div class="shop-item-header">
                            <strong>${pack.label}</strong>
                            <span class="stars-price">${pack.stars} ‚≠ê</span>
                        </div>
                        <div style="color:#a0a0ff;font-size:14px;margin:10px 0;">
                            –ü–æ–ª—É—á–∏—Ç–µ: <strong>${pack.crystals} üíé</strong>
                        </div>
                        <button class="btn-buy btn-stars" onclick="buyWithTelegramStars(${pack.stars})">
                            –ö–£–ü–ò–¢–¨ –ó–ê ${pack.stars} ‚≠ê
                        </button>
                    `;
                    
                    container.appendChild(div);
                });
                
                const infoDiv = document.createElement('div');
                infoDiv.style.cssText = 'margin-top:20px;padding:15px;background:rgba(255,255,255,0.05);border-radius:10px;font-size:14px;';
                infoDiv.innerHTML = `
                    <strong>üí´ –ß—Ç–æ —Ç–∞–∫–æ–µ Telegram Stars?</strong><br>
                    –í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –≤–∞–ª—é—Ç–∞ Telegram –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤.<br>
                    –ü–æ–∫—É–ø–∞–µ—Ç—Å—è –≤ Telegram –∑–∞ —Ä–µ–∞–ª—å–Ω—ã–µ –¥–µ–Ω—å–≥–∏.<br>
                    100% –∏–¥–µ—Ç –Ω–∞ —Ä–∞–∑–≤–∏—Ç–∏–µ –∏–≥—Ä—ã (–ø–æ—Å–ª–µ –∫–æ–º–∏—Å—Å–∏–∏ –º–∞–≥–∞–∑–∏–Ω–∞).
                `;
                container.appendChild(infoDiv);
                
                document.getElementById('shopModal').style.display = 'block';
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ Stars –ø–∞–∫–µ—Ç–æ–≤:', error);
                showStatus('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏', 'error');
            }
        }
        
        // –û–±—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–∞–≥–∞–∑–∏–Ω–∞
        async function openShop() {
            const container = document.getElementById('shopList');
            container.innerHTML = `
                <div style="text-align:center;margin-bottom:20px;">
                    <h3>üõí –ú–ê–ì–ê–ó–ò–ù</h3>
                    <p>–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é:</p>
                </div>
                <button class="btn" onclick="openCrystalsShop()" style="margin-bottom:10px;">
                    üíé –ú–ê–ì–ê–ó–ò–ù –ö–†–ò–°–¢–ê–õ–õ–û–í
                </button>
                <button class="btn btn-stars" onclick="openStarsShop()" style="margin-bottom:10px;">
                    ‚≠ê TELEGRAM STARS
                </button>
                <button class="btn" onclick="openBoostsShop()" style="background:linear-gradient(45deg,#00cc66,#00ffaa);">
                    ‚ö° –ë–£–°–¢–ï–†–´ –ò –£–°–ö–û–†–ï–ù–ò–Ø
                </button>
            `;
            
            document.getElementById('shopModal').style.display = 'block';
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        function showStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            
            const colors = {
                error: '#ff4444',
                success: '#00cc66',
                warning: '#ffaa00',
                info: '#0088ff'
            };
            
            statusEl.style.borderLeftColor = colors[type] || colors.info;
            
            if (type === 'success') {
                setTimeout(() => {
                    statusEl.textContent = '‚ö° –ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!';
                    statusEl.style.borderLeftColor = colors.info;
                }, 3000);
            }
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        document.addEventListener('DOMContentLoaded', () => {
            loadPlayerData();
            
            setInterval(() => {
                if (playerData) {
                    updateDisplay();
                }
            }, 30000);
        });
    </script>
</body>
</html>